<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hillway | Training Admin Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --primary: #0f172a;
      --secondary: #1e40af;
      --accent: #0ea5e9;
      --bg: #f8fafc;
      --white: #ffffff;
      --gray-50: #f8fafc;
      --gray-100: #f1f5f9;
      --gray-200: #e2e8f0;
      --gray-300: #cbd5e1;
      --gray-400: #94a3b8;
      --gray-500: #64748b;
      --gray-600: #475569;
      --gray-700: #334155;
      --gray-800: #1e293b;
      --green: #16a34a;
      --green-light: #dcfce7;
      --amber: #d97706;
      --amber-light: #fef3c7;
      --red: #dc2626;
      --red-light: #fee2e2;
    }

    html { scroll-behavior: smooth; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--primary);
      line-height: 1.6;
      font-size: 15px;
      -webkit-font-smoothing: antialiased;
    }

    /* Password overlay */
    #auth-overlay {
      position: fixed;
      inset: 0;
      background: var(--primary);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 24px;
    }

    #auth-overlay.hidden { display: none; }

    .auth-box {
      background: var(--white);
      border-radius: 16px;
      padding: 48px;
      max-width: 400px;
      width: 90%;
      text-align: center;
      box-shadow: 0 25px 50px rgba(0,0,0,0.3);
    }

    .auth-box img {
      height: 28px;
      margin-bottom: 32px;
    }

    .auth-box h2 {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--primary);
    }

    .auth-box p {
      font-size: 14px;
      color: var(--gray-500);
      margin-bottom: 24px;
    }

    .auth-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--gray-200);
      border-radius: 10px;
      font-size: 15px;
      font-family: inherit;
      outline: none;
      transition: border-color 0.2s;
    }

    .auth-input:focus {
      border-color: var(--accent);
    }

    .auth-input.error {
      border-color: var(--red);
      animation: shake 0.4s;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-8px); }
      75% { transform: translateX(8px); }
    }

    .auth-btn {
      width: 100%;
      padding: 12px;
      margin-top: 16px;
      background: var(--secondary);
      color: var(--white);
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: background 0.2s;
    }

    .auth-btn:hover { background: var(--primary); }

    .auth-error {
      color: var(--red);
      font-size: 13px;
      margin-top: 12px;
      display: none;
    }

    /* Header */
    .header {
      background: var(--primary);
      padding: 20px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 24px;
    }

    .header-left img { height: 24px; }

    .header-left h1 {
      color: var(--white);
      font-size: 16px;
      font-weight: 600;
      letter-spacing: -0.02em;
    }

    .header-left .badge {
      background: rgba(14, 165, 233, 0.15);
      color: var(--accent);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .header-right a {
      color: var(--gray-400);
      text-decoration: none;
      font-size: 13px;
      font-weight: 500;
      transition: color 0.2s;
    }

    .header-right a:hover { color: var(--white); }

    .refresh-btn {
      background: rgba(255,255,255,0.1);
      color: var(--white);
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.2s;
    }

    .refresh-btn:hover { background: rgba(255,255,255,0.2); }

    .refresh-btn svg {
      width: 14px;
      height: 14px;
    }

    .refresh-btn.spinning svg {
      animation: spin 0.6s linear;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .last-refresh {
      color: var(--gray-400);
      font-size: 12px;
    }

    /* Main content */
    .main {
      max-width: 1280px;
      margin: 0 auto;
      padding: 32px;
    }

    /* Learner info bar */
    .learner-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 32px;
    }

    .learner-info {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .learner-avatar {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--secondary), var(--accent));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--white);
      font-weight: 700;
      font-size: 18px;
    }

    .learner-name {
      font-size: 20px;
      font-weight: 700;
      color: var(--primary);
    }

    .learner-email {
      font-size: 13px;
      color: var(--gray-500);
    }

    /* Overview cards */
    .overview-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--white);
      border-radius: 14px;
      padding: 24px;
      border: 1px solid var(--gray-200);
      transition: box-shadow 0.2s;
    }

    .stat-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    }

    .stat-label {
      font-size: 13px;
      font-weight: 500;
      color: var(--gray-500);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .stat-label svg {
      width: 16px;
      height: 16px;
      color: var(--accent);
    }

    .stat-value {
      font-size: 32px;
      font-weight: 800;
      color: var(--primary);
      letter-spacing: -0.03em;
    }

    .stat-sub {
      font-size: 12px;
      color: var(--gray-400);
      margin-top: 4px;
    }

    /* Section titles */
    .section-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-title svg {
      width: 20px;
      height: 20px;
      color: var(--accent);
    }

    /* Course progress cards */
    .courses-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 40px;
    }

    .course-card {
      background: var(--white);
      border-radius: 14px;
      padding: 24px;
      border: 1px solid var(--gray-200);
      transition: box-shadow 0.2s;
    }

    .course-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    }

    .course-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .course-name {
      font-size: 15px;
      font-weight: 700;
      color: var(--primary);
    }

    .course-accuracy {
      font-size: 24px;
      font-weight: 800;
      letter-spacing: -0.03em;
    }

    .accuracy-green { color: var(--green); }
    .accuracy-amber { color: var(--amber); }
    .accuracy-red { color: var(--red); }

    .course-stats {
      display: flex;
      gap: 24px;
      margin-bottom: 16px;
    }

    .course-stat {
      font-size: 13px;
      color: var(--gray-500);
    }

    .course-stat strong {
      color: var(--primary);
      font-weight: 600;
    }

    .progress-bar-track {
      height: 8px;
      background: var(--gray-100);
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.6s ease;
    }

    .fill-green { background: var(--green); }
    .fill-amber { background: var(--amber); }
    .fill-red { background: var(--red); }

    .no-data-course {
      color: var(--gray-400);
      font-size: 13px;
      font-style: italic;
    }

    /* Activity feed */
    .activity-section {
      margin-bottom: 40px;
    }

    .activity-feed {
      background: var(--white);
      border-radius: 14px;
      border: 1px solid var(--gray-200);
      overflow: hidden;
    }

    .activity-item {
      padding: 16px 24px;
      border-bottom: 1px solid var(--gray-100);
      display: flex;
      align-items: flex-start;
      gap: 16px;
    }

    .activity-item:last-child { border-bottom: none; }

    .activity-time {
      font-size: 12px;
      color: var(--gray-400);
      min-width: 120px;
      padding-top: 2px;
    }

    .activity-content {
      flex: 1;
    }

    .activity-course {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--secondary);
      margin-bottom: 4px;
    }

    .activity-question {
      font-size: 14px;
      color: var(--primary);
      margin-bottom: 6px;
    }

    .activity-answer {
      font-size: 13px;
      color: var(--gray-600);
    }

    .activity-answer .answer-text {
      font-weight: 500;
    }

    .activity-correct-note {
      color: var(--red);
      font-size: 12px;
      margin-top: 4px;
    }

    .badge-correct {
      display: inline-block;
      background: var(--green-light);
      color: var(--green);
      padding: 2px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-incorrect {
      display: inline-block;
      background: var(--red-light);
      color: var(--red);
      padding: 2px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    /* Quiz results table */
    .table-section { margin-bottom: 40px; }

    .table-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .filter-select {
      padding: 8px 16px;
      border: 2px solid var(--gray-200);
      border-radius: 8px;
      font-size: 13px;
      font-family: inherit;
      color: var(--primary);
      background: var(--white);
      cursor: pointer;
      outline: none;
      transition: border-color 0.2s;
    }

    .filter-select:focus { border-color: var(--accent); }

    .results-table-wrap {
      background: var(--white);
      border-radius: 14px;
      border: 1px solid var(--gray-200);
      overflow: hidden;
    }

    .results-table {
      width: 100%;
      border-collapse: collapse;
    }

    .results-table thead th {
      background: var(--gray-50);
      padding: 12px 20px;
      text-align: left;
      font-size: 12px;
      font-weight: 600;
      color: var(--gray-500);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid var(--gray-200);
    }

    .results-table tbody td {
      padding: 14px 20px;
      font-size: 14px;
      color: var(--primary);
      border-bottom: 1px solid var(--gray-100);
      vertical-align: top;
    }

    .results-table tbody tr:last-child td { border-bottom: none; }

    .results-table tbody tr:hover {
      background: var(--gray-50);
    }

    .results-table .col-question { max-width: 300px; }

    .results-table .col-answer { max-width: 200px; }

    .row-incorrect {
      background: rgba(254, 226, 226, 0.3);
    }

    .row-incorrect:hover {
      background: rgba(254, 226, 226, 0.5) !important;
    }

    .attempt-badge {
      display: inline-block;
      background: var(--gray-100);
      color: var(--gray-600);
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--gray-400);
    }

    .empty-state svg {
      width: 48px;
      height: 48px;
      margin-bottom: 16px;
      opacity: 0.4;
    }

    .empty-state p {
      font-size: 15px;
      font-weight: 500;
    }

    .empty-state .sub {
      font-size: 13px;
      margin-top: 4px;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 60px;
      color: var(--gray-400);
      font-size: 14px;
    }

    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--gray-200);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .overview-grid { grid-template-columns: repeat(2, 1fr); }
      .courses-grid { grid-template-columns: 1fr; }
    }

    @media (max-width: 768px) {
      .main { padding: 20px 16px; }
      .header { padding: 16px; }
      .overview-grid { grid-template-columns: 1fr; }
      .learner-bar { flex-direction: column; align-items: flex-start; gap: 12px; }
      .stat-value { font-size: 24px; }
      .activity-item { flex-direction: column; gap: 8px; }
      .activity-time { min-width: auto; }
      .results-table-wrap { overflow-x: auto; }
      .results-table { min-width: 700px; }
      .header-left h1 { font-size: 14px; }
      .header-right { gap: 8px; }
      .header-right a { display: none; }
    }

    @media (max-width: 480px) {
      .header-left .badge { display: none; }
      .course-stats { flex-direction: column; gap: 4px; }
    }
  </style>
</head>
<body>

<!-- Password Auth Overlay -->
<div id="auth-overlay">
  <div class="auth-box">
    <img src="https://www.hillwayco.uk/images/logo.png" alt="Hillway">
    <h2>Training Admin</h2>
    <p>Enter the admin password to view Alex's training progress.</p>
    <input type="password" id="auth-password" class="auth-input" placeholder="Password" autofocus>
    <button class="auth-btn" onclick="attemptLogin()">Sign In</button>
    <p class="auth-error" id="auth-error">Incorrect password. Try again.</p>
  </div>
</div>

<!-- Header -->
<header class="header" id="main-header" style="display:none;">
  <div class="header-left">
    <img src="https://www.hillwayco.uk/images/logo.png" alt="Hillway">
    <h1>Training Admin Dashboard</h1>
    <span class="badge">Live</span>
  </div>
  <div class="header-right">
    <span class="last-refresh" id="last-refresh"></span>
    <button class="refresh-btn" id="refresh-btn" onclick="refreshData()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
      Refresh
    </button>
    <a href="induction.html">Back to Induction</a>
  </div>
</header>

<!-- Main Content -->
<main class="main" id="main-content" style="display:none;">

  <!-- Learner Bar -->
  <div class="learner-bar">
    <div class="learner-info">
      <div class="learner-avatar" id="learner-avatar">AB</div>
      <div>
        <div class="learner-name" id="learner-name">Alex Brazier</div>
        <div class="learner-email" id="learner-email">Loading...</div>
      </div>
    </div>
  </div>

  <!-- Overview Cards -->
  <div class="overview-grid" id="overview-grid">
    <div class="stat-card">
      <div class="stat-label">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
        Questions Answered
      </div>
      <div class="stat-value" id="stat-total">--</div>
      <div class="stat-sub" id="stat-total-sub">Loading...</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
        Overall Accuracy
      </div>
      <div class="stat-value" id="stat-accuracy">--</div>
      <div class="stat-sub" id="stat-accuracy-sub">Loading...</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
        Courses
      </div>
      <div class="stat-value" id="stat-courses">--</div>
      <div class="stat-sub" id="stat-courses-sub">Loading...</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
        Last Activity
      </div>
      <div class="stat-value" id="stat-last-activity" style="font-size:20px;">--</div>
      <div class="stat-sub" id="stat-last-activity-sub">Loading...</div>
    </div>
  </div>

  <!-- Course Progress -->
  <div class="section-title">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
    Course Progress
  </div>
  <div class="courses-grid" id="courses-grid">
    <div class="loading"><div class="loading-spinner"></div>Loading course data...</div>
  </div>

  <!-- Recent Activity -->
  <div class="activity-section">
    <div class="section-title">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
      Recent Activity
    </div>
    <div class="activity-feed" id="activity-feed">
      <div class="loading"><div class="loading-spinner"></div>Loading activity...</div>
    </div>
  </div>

  <!-- Detailed Quiz Results -->
  <div class="table-section">
    <div class="table-controls">
      <div class="section-title" style="margin-bottom:0;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>
        Detailed Quiz Results
      </div>
      <select class="filter-select" id="course-filter" onchange="renderQuizTable()">
        <option value="all">All Courses</option>
        <option value="property-fundamentals">Property Fundamentals</option>
        <option value="property-management">Property Management</option>
        <option value="ai-digital-transformation">AI & Digital Transformation</option>
        <option value="claude-code-training">Claude Code Training</option>
      </select>
    </div>
    <div class="results-table-wrap" id="results-table-wrap">
      <div class="loading"><div class="loading-spinner"></div>Loading results...</div>
    </div>
  </div>

</main>

<script>
// Supabase config
const SUPABASE_URL = 'https://wlkxzlyxizkajlkureka.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indsa3h6bHl4aXprYWpsa3VyZWthIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczNjAyOTUsImV4cCI6MjA4MjkzNjI5NX0.INIobuEI1GxHDyKGa-hFU8gUMZ0U6Ete3LK7CaBO5Us';
const PASSWORD = 'hillway2026';

const COURSE_NAMES = {
  'property-fundamentals': 'Property Fundamentals',
  'property-management': 'Property Management',
  'ai-digital-transformation': 'AI & Digital Transformation',
  'claude-code-training': 'Claude Code Training'
};

const COURSE_SECTIONS = {
  'property-fundamentals': 10,
  'property-management': 10,
  'ai-digital-transformation': 10,
  'claude-code-training': 8
};

let quizData = [];
let progressData = [];
let learnerData = null;
let refreshInterval = null;

// --- AUTH ---
function attemptLogin() {
  const input = document.getElementById('auth-password');
  const error = document.getElementById('auth-error');

  if (input.value === PASSWORD) {
    sessionStorage.setItem('hillway-admin-auth', 'true');
    showDashboard();
  } else {
    input.classList.add('error');
    error.style.display = 'block';
    setTimeout(() => input.classList.remove('error'), 400);
  }
}

document.getElementById('auth-password').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') attemptLogin();
});

function checkAuth() {
  if (sessionStorage.getItem('hillway-admin-auth') === 'true') {
    showDashboard();
  }
}

function showDashboard() {
  document.getElementById('auth-overlay').classList.add('hidden');
  document.getElementById('main-header').style.display = 'flex';
  document.getElementById('main-content').style.display = 'block';
  refreshData();
  refreshInterval = setInterval(refreshData, 30000);
}

// --- SUPABASE API ---
async function supabaseGet(table, params) {
  params = params || '';
  const url = SUPABASE_URL + '/rest/v1/' + table + '?' + params;
  const res = await fetch(url, {
    headers: {
      'apikey': SUPABASE_KEY,
      'Authorization': 'Bearer ' + SUPABASE_KEY,
      'Content-Type': 'application/json'
    }
  });
  if (!res.ok) throw new Error('API error: ' + res.status);
  return res.json();
}

// --- UTILS ---
function escapeHtml(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function formatRelativeTime(date) {
  const now = new Date();
  const diff = now - date;
  const mins = Math.floor(diff / 60000);
  const hours = Math.floor(diff / 3600000);
  const days = Math.floor(diff / 86400000);

  if (mins < 1) return 'Just now';
  if (mins < 60) return mins + 'm ago';
  if (hours < 24) return hours + 'h ago';
  if (days === 1) return 'Yesterday';
  if (days < 7) return days + 'd ago';
  return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
}

function updateRefreshTime() {
  const now = new Date();
  document.getElementById('last-refresh').textContent =
    'Last refreshed: ' + now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
}

// --- SAFE DOM HELPERS ---
// These helpers build DOM elements without raw innerHTML to avoid XSS.
// For static HTML structures, we use a sanitized approach.

function clearAndAppend(parentId, elements) {
  const parent = document.getElementById(parentId);
  parent.textContent = '';
  if (Array.isArray(elements)) {
    elements.forEach(el => parent.appendChild(el));
  } else {
    parent.appendChild(elements);
  }
}

function el(tag, attrs, children) {
  const node = document.createElement(tag);
  if (attrs) {
    Object.keys(attrs).forEach(key => {
      if (key === 'className') node.className = attrs[key];
      else if (key === 'textContent') node.textContent = attrs[key];
      else if (key === 'style') Object.assign(node.style, attrs[key]);
      else node.setAttribute(key, attrs[key]);
    });
  }
  if (children) {
    if (typeof children === 'string') node.textContent = children;
    else if (Array.isArray(children)) children.forEach(c => { if (c) node.appendChild(c); });
    else node.appendChild(children);
  }
  return node;
}

// --- DATA LOADING ---
async function refreshData() {
  const btn = document.getElementById('refresh-btn');
  btn.classList.add('spinning');

  try {
    const results = await Promise.all([
      supabaseGet('training_learners', 'select=*'),
      supabaseGet('training_quiz_submissions', 'select=*&order=created_at.desc'),
      supabaseGet('training_course_progress', 'select=*&order=completed_at.desc')
    ]);

    learnerData = results[0].length > 0 ? results[0][0] : null;
    quizData = results[1];
    progressData = results[2];

    renderLearnerInfo();
    renderOverview();
    renderCourses();
    renderActivity();
    renderQuizTable();
    updateRefreshTime();
  } catch (err) {
    console.error('Data refresh error:', err);
  }

  setTimeout(function() { btn.classList.remove('spinning'); }, 600);
}

// --- RENDER: Learner Info ---
function renderLearnerInfo() {
  if (learnerData) {
    document.getElementById('learner-name').textContent = learnerData.name || 'Alex Brazier';
    document.getElementById('learner-email').textContent = learnerData.email || '';
    var initials = (learnerData.name || 'AB').split(' ').map(function(n) { return n[0]; }).join('').toUpperCase();
    document.getElementById('learner-avatar').textContent = initials;
  }
}

// --- RENDER: Overview ---
function renderOverview() {
  var total = quizData.length;
  var correct = quizData.filter(function(q) { return q.is_correct; }).length;
  var accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;

  var coursesWithQuizzes = {};
  quizData.forEach(function(q) { coursesWithQuizzes[q.course] = true; });
  var coursesWithProgress = {};
  progressData.forEach(function(p) { coursesWithProgress[p.course] = true; });
  var allCourses = Object.assign({}, coursesWithQuizzes, coursesWithProgress);
  var started = Object.keys(allCourses).length;

  var completed = 0;
  Object.keys(COURSE_SECTIONS).forEach(function(course) {
    var sections = {};
    progressData.filter(function(p) { return p.course === course; }).forEach(function(p) { sections[p.section_id] = true; });
    if (Object.keys(sections).length >= COURSE_SECTIONS[course]) completed++;
  });

  var lastActivity = '--';
  var lastActivitySub = 'No activity yet';
  if (quizData.length > 0) {
    var latest = new Date(quizData[0].created_at);
    lastActivity = formatRelativeTime(latest);
    lastActivitySub = latest.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) +
      ' at ' + latest.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
  }

  document.getElementById('stat-total').textContent = total;
  document.getElementById('stat-total-sub').textContent = correct + ' correct, ' + (total - correct) + ' incorrect';

  document.getElementById('stat-accuracy').textContent = total > 0 ? accuracy + '%' : '--';
  document.getElementById('stat-accuracy-sub').textContent = total > 0 ? correct + ' of ' + total + ' correct' : 'No quizzes taken';

  document.getElementById('stat-courses').textContent = started + ' / 4';
  document.getElementById('stat-courses-sub').textContent = completed + ' completed';

  document.getElementById('stat-last-activity').textContent = lastActivity;
  document.getElementById('stat-last-activity-sub').textContent = lastActivitySub;
}

// --- RENDER: Courses ---
function renderCourses() {
  var grid = document.getElementById('courses-grid');
  var courses = Object.keys(COURSE_NAMES);
  var fragment = document.createDocumentFragment();

  courses.forEach(function(course) {
    var courseQuizzes = quizData.filter(function(q) { return q.course === course; });
    var courseProgress = progressData.filter(function(p) { return p.course === course; });
    var sectionSet = {};
    courseProgress.forEach(function(p) { sectionSet[p.section_id] = true; });
    var sectionsCompleted = Object.keys(sectionSet).length;
    var totalSections = COURSE_SECTIONS[course];
    var totalQ = courseQuizzes.length;
    var correctQ = courseQuizzes.filter(function(q) { return q.is_correct; }).length;
    var accuracy = totalQ > 0 ? Math.round((correctQ / totalQ) * 100) : 0;
    var progressPct = Math.round((sectionsCompleted / totalSections) * 100);

    var colorClass = 'green';
    if (totalQ > 0 && accuracy < 50) colorClass = 'red';
    else if (totalQ > 0 && accuracy < 80) colorClass = 'amber';

    var hasData = totalQ > 0 || sectionsCompleted > 0;

    var card = el('div', { className: 'course-card' });
    var header = el('div', { className: 'course-header' });
    header.appendChild(el('div', { className: 'course-name' }, COURSE_NAMES[course]));
    if (hasData) {
      header.appendChild(el('div', { className: 'course-accuracy accuracy-' + colorClass }, accuracy + '%'));
    }
    card.appendChild(header);

    if (hasData) {
      var stats = el('div', { className: 'course-stats' });
      var s1 = el('div', { className: 'course-stat' });
      s1.appendChild(document.createTextNode('Sections: '));
      s1.appendChild(el('strong', {}, sectionsCompleted + ' / ' + totalSections));
      stats.appendChild(s1);
      var s2 = el('div', { className: 'course-stat' });
      s2.appendChild(document.createTextNode('Quiz: '));
      s2.appendChild(el('strong', {}, correctQ + ' / ' + totalQ + ' correct'));
      stats.appendChild(s2);
      card.appendChild(stats);

      var track = el('div', { className: 'progress-bar-track' });
      var fill = el('div', { className: 'progress-bar-fill fill-' + colorClass });
      fill.style.width = progressPct + '%';
      track.appendChild(fill);
      card.appendChild(track);
    } else {
      card.appendChild(el('div', { className: 'no-data-course' }, 'No data yet -- course not started'));
    }

    fragment.appendChild(card);
  });

  grid.textContent = '';
  grid.appendChild(fragment);
}

// --- RENDER: Activity Feed ---
function renderActivity() {
  var feed = document.getElementById('activity-feed');
  var recent = quizData.slice(0, 20);

  if (recent.length === 0) {
    feed.textContent = '';
    var empty = el('div', { className: 'empty-state' });
    var svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('viewBox', '0 0 24 24');
    svg.setAttribute('fill', 'none');
    svg.setAttribute('stroke', 'currentColor');
    svg.setAttribute('stroke-width', '2');
    svg.style.width = '48px';
    svg.style.height = '48px';
    svg.style.marginBottom = '16px';
    svg.style.opacity = '0.4';
    var polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
    polyline.setAttribute('points', '22 12 18 12 15 21 9 3 6 12 2 12');
    svg.appendChild(polyline);
    empty.appendChild(svg);
    empty.appendChild(el('p', {}, 'No activity yet'));
    empty.appendChild(el('p', { className: 'sub' }, "Quiz answers will appear here as Alex completes them."));
    feed.appendChild(empty);
    return;
  }

  feed.textContent = '';
  var fragment = document.createDocumentFragment();

  recent.forEach(function(item) {
    var time = new Date(item.created_at);
    var timeStr = time.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) +
      ' ' + time.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
    var courseName = COURSE_NAMES[item.course] || item.course;

    var row = el('div', { className: 'activity-item' });
    row.appendChild(el('div', { className: 'activity-time' }, timeStr));

    var content = el('div', { className: 'activity-content' });
    content.appendChild(el('div', { className: 'activity-course' }, courseName));
    content.appendChild(el('div', { className: 'activity-question' }, item.question_text || item.question_id));

    var answerDiv = el('div', { className: 'activity-answer' });
    answerDiv.appendChild(document.createTextNode('Answered: '));
    answerDiv.appendChild(el('span', { className: 'answer-text' }, item.answer_given));
    answerDiv.appendChild(document.createTextNode(' '));
    if (item.is_correct) {
      answerDiv.appendChild(el('span', { className: 'badge-correct' }, 'Correct'));
    } else {
      answerDiv.appendChild(el('span', { className: 'badge-incorrect' }, 'Incorrect'));
    }
    content.appendChild(answerDiv);

    if (!item.is_correct) {
      content.appendChild(el('div', { className: 'activity-correct-note' }, 'Correct answer: ' + (item.correct_answer || '')));
    }

    row.appendChild(content);
    fragment.appendChild(row);
  });

  feed.appendChild(fragment);
}

// --- RENDER: Quiz Table ---
function renderQuizTable() {
  var wrap = document.getElementById('results-table-wrap');
  var filter = document.getElementById('course-filter').value;

  var filtered = quizData;
  if (filter !== 'all') {
    filtered = quizData.filter(function(q) { return q.course === filter; });
  }

  if (filtered.length === 0) {
    wrap.textContent = '';
    var empty = el('div', { className: 'empty-state' });
    var svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('viewBox', '0 0 24 24');
    svg.setAttribute('fill', 'none');
    svg.setAttribute('stroke', 'currentColor');
    svg.setAttribute('stroke-width', '2');
    svg.style.width = '48px';
    svg.style.height = '48px';
    svg.style.marginBottom = '16px';
    svg.style.opacity = '0.4';
    var path1 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path1.setAttribute('d', 'M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z');
    svg.appendChild(path1);
    empty.appendChild(svg);
    empty.appendChild(el('p', {}, 'No quiz results yet'));
    var subText = filter !== 'all' ? 'No results for this course.' : 'Results will appear as Alex takes quizzes.';
    empty.appendChild(el('p', { className: 'sub' }, subText));
    wrap.appendChild(empty);
    return;
  }

  wrap.textContent = '';
  var table = el('table', { className: 'results-table' });

  // thead
  var thead = document.createElement('thead');
  var headRow = document.createElement('tr');
  ['Course', 'Question', "Alex's Answer", 'Correct Answer', 'Result', 'Attempt', 'Date'].forEach(function(text) {
    var th = document.createElement('th');
    th.textContent = text;
    if (text === 'Question') th.className = 'col-question';
    if (text === "Alex's Answer" || text === 'Correct Answer') th.className = 'col-answer';
    headRow.appendChild(th);
  });
  thead.appendChild(headRow);
  table.appendChild(thead);

  // tbody
  var tbody = document.createElement('tbody');

  filtered.forEach(function(item) {
    var time = new Date(item.created_at);
    var dateStr = time.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
    var timeStr = time.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
    var courseName = COURSE_NAMES[item.course] || item.course;

    var tr = document.createElement('tr');
    if (!item.is_correct) tr.className = 'row-incorrect';

    // Course
    var td1 = document.createElement('td');
    var courseSpan = el('span', { style: { fontSize: '12px', fontWeight: '600', color: 'var(--secondary)' } }, courseName);
    td1.appendChild(courseSpan);
    tr.appendChild(td1);

    // Question
    var td2 = el('td', { className: 'col-question' }, item.question_text || item.question_id);
    tr.appendChild(td2);

    // Alex's Answer
    var td3 = el('td', { className: 'col-answer' }, item.answer_given);
    tr.appendChild(td3);

    // Correct Answer
    var td4 = el('td', { className: 'col-answer' }, item.correct_answer);
    tr.appendChild(td4);

    // Result
    var td5 = document.createElement('td');
    if (item.is_correct) {
      td5.appendChild(el('span', { className: 'badge-correct' }, 'Correct'));
    } else {
      td5.appendChild(el('span', { className: 'badge-incorrect' }, 'Incorrect'));
    }
    tr.appendChild(td5);

    // Attempt
    var td6 = document.createElement('td');
    td6.appendChild(el('span', { className: 'attempt-badge' }, '#' + (item.attempt_number || 1)));
    tr.appendChild(td6);

    // Date
    var td7 = document.createElement('td');
    td7.style.whiteSpace = 'nowrap';
    td7.style.fontSize = '13px';
    td7.style.color = 'var(--gray-500)';
    td7.appendChild(document.createTextNode(dateStr));
    td7.appendChild(document.createElement('br'));
    td7.appendChild(document.createTextNode(timeStr));
    tr.appendChild(td7);

    tbody.appendChild(tr);
  });

  table.appendChild(tbody);
  wrap.appendChild(table);
}

// --- INIT ---
checkAuth();
</script>

</body>
</html>
